# Система лояльности «Гофермарт»

Система лояльности для накопления и использования баллов за покупки.

## Описание

Система представляет собой HTTP API для:
- Регистрации и аутентификации пользователей
- Приема номеров заказов от пользователей
- Учета накопительного счета пользователей
- Проверки заказов через систему расчета баллов лояльности
- Начисления баллов за подходящие заказы

## Архитектура

- **cmd/gophermart** - точка входа в приложение
- **internal/config** - конфигурация приложения
- **internal/models** - модели данных
- **internal/storage** - слой хранения данных (PostgreSQL)
- **internal/services** - бизнес-логика (аутентификация, начисление баллов)
- **internal/server** - HTTP сервер и обработчики
- **internal/middleware** - middleware для аутентификации и сжатия
- **internal/utils** - утилиты (валидация)

## Структура проекта

```
├── cmd/gophermart/          # Точка входа
├── internal/
│   ├── config/              # Конфигурация
│   ├── models/              # Модели данных
│   ├── storage/             # Слой хранения
│   ├── services/            # Бизнес-логика
│   ├── server/              # HTTP сервер
│   ├── middleware/          # Middleware
│   └── utils/               # Утилиты
├── migrations/              # Миграции БД
├── scripts/                 # Скрипты
├── examples/                # Примеры
└── docs/                    # Документация
```

## Установка и запуск

### Требования
- Go 1.24+
- PostgreSQL 15+
- Docker (опционально)
- 
### 1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd go-musthave-diploma-tpl
```
  
### 2. Установите зависимости:
```bash
make deps
```
  
### 3. Скачать statictest
```bash
make download-statictest
```

### 4. Проверить код
```bash
make check-all
```

### 5. Запустить с Docker
```bash
docker compose up -d
```

### 6. Или запустить локально
```bash
# Собрать приложение 
make build

# Настроить базу данных
export DATABASE_URI="postgres://postgres:postgres@localhost:5432/praktikum?sslmode=disable"
make migrate

# Запустить приложение
make run
```

Приложение будет доступно по адресу http://localhost:8080

## Основные команды

```bash
# Сборка
make build

# Генерация моков
make generate-mocks

# Тестирование
make test

# Интеграционные тесты
make test-integration

# Линтинг
make lint

# Статический анализ
make statictest

# Полная проверка
make check-all

# Запуск
make run
```

## Разработка

## API тестирование

```bash
# Запустить пример API
./examples/api_example.sh
```

## API Endpoints

### Публичные эндпоинты
- `POST /api/user/register` - регистрация пользователя
- `POST /api/user/login` - аутентификация пользователя

### Защищенные эндпоинты
- `POST /api/user/orders` - загрузка номера заказа
- `GET /api/user/orders` - получение списка заказов
- `GET /api/user/balance` - получение баланса
- `POST /api/user/balance/withdraw` - списание средств
- `GET /api/user/withdrawals` - получение списка списаний


## Конфигурация

Приложение поддерживает конфигурацию через переменные окружения или флаги командной строки:

- `RUN_ADDRESS` / `-a` - адрес и порт запуска сервера (по умолчанию: localhost:8080)
- `DATABASE_URI` / `-d` - строка подключения к базе данных (обязательно)
- `ACCRUAL_SYSTEM_ADDRESS` / `-r` - адрес системы начисления баллов
- `ORDER_PROCESS_INTERVAL` / `-i` - интервал обработки заказов (по умолчанию: 5s)
- `WORKER_COUNT` / `-w` - количество воркеров для параллельной обработки заказов (по умолчанию: 5)

Пример запуска с 10 воркерами:

```bash
./gophermart -w 10
# или
export WORKER_COUNT=10
./gophermart
```

## Структура базы данных

### Таблицы
- `users` - пользователи системы
- `orders` - заказы пользователей
- `balances` - балансы пользователей
- `withdrawals` - списания средств

### Миграции
Миграции находятся в папке `migrations/` и выполняются с помощью goose.

## Особенности реализации

1. **Аутентификация**: JWT токены с bcrypt хешированием паролей
2. **Валидация**: Алгоритм Луна для проверки номеров заказов
3. **Сжатие**: Поддержка gzip для HTTP ответов
4. **Фоновая обработка**: Автоматическая обработка заказов через систему начисления
5. **Graceful shutdown**: Корректное завершение работы сервера
6. **Retry логика**: Экспоненциальная задержка с jitter для HTTP запросов к accrual системе
